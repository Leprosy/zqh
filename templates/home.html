<!DOCTYPE html>
<html>
    <head>
        <style>
        .content{width:80%;margin:1em auto;}
        </style>
        <link rel="stylesheet" href="css/pure.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8">
        <title>This is zqh รก</title>
    </head>

    <body>
        <div class="content" id="game">
            <h1></h1>
            <div class="pure-g">
                <div class="pure-u-1-5">
                    <div id="side"></div>
                </div>

                <div class="pure-u-3-5">
                    <div id="3d"></div>
                </div>

                <div class="pure-u-1-5">
                    <div id="map"></div>
                    <div id="commands">
                        <table>
                            <tr>
                                <td></td>
                                <td><button onclick="Game.forward()">^</button></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td><button onclick="Game.rotateLeft()">&lt;</button></td>
                                <td><button onclick="Game.backward()">v</button></td>
                                <td><button onclick="Game.rotateRight()">></button></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script src="js/jquery.js"></script>
        <script src="js/crafty.js"></script>
        <script src="js/three.js"></script>
        <script src="js/lib.js"></script>
<script>
/**
* Game stuff
*/
var Game = {};
Game.size = 100;
Game.map = null;
Game.lightSize = 1;
Game.lightVar = 0.1;
Game.moveSpeed = 250;
Game.isMoving = false;
Game.debug = false;

// @todo: Should refactor these into a class
Game.player = {};
Game.player.x = 0;
Game.player.y = 0;




Game.render2dMap = function(map) {
    var tile = $("#map").width() / map.width;
    Game.map2dSize = tile;

    Crafty.init(map.width * tile, map.height * tile, "map");
    Crafty.pixelart(true);
    Crafty.background('#004');

    for (i = 0; i < map.floors.length; ++i) {
        var floor = map.floors[i];

        Crafty.e("2D, Canvas, Color")
              .attr({ x: floor.x * tile, y: floor.y * tile, w: tile - 1, h: tile - 1 })
              .color("#666666");
    }

    for (i = 0; i < map.walls.length; ++i) {
        var wall = map.walls[i];

        Crafty.e("2D, Canvas, Color")
              .attr({ x: wall.x * tile, y: wall.y * tile, w: tile - 1, h: tile - 1 })
              .color("#ffffff");
    }

    for (i = 0; i < map.objects.length; ++i) {
        var obj = map.objects[i];
        var color = "";

        switch(obj.v) {
            case 1:
                color = "#00ff00";
                break;
            case 2:
                color = "#ff00ff";
                break;
            default:
                color = "#ffff00";
                break;
        }

        var ent = Crafty.e("2D, Canvas, Color")
                        .attr({ x: obj.x * tile, y: obj.y * tile, w: tile - 1, h: tile - 1 })
                        .color(color);
        if (obj.v == 1) Game.map2dPoint = ent;
    }
}

/**
 * Initializes 3d components
 */
Game.init3d = function() {
    // Init components
    var $container = $("#3d");
    Game.scene = new THREE.Scene();
    Game.renderer = new THREE.WebGLRenderer();
    Game.renderer.setSize($container.width(), $container.width() * 0.8);
    Game.camera = new THREE.PerspectiveCamera(75, 1.2, 0.1, 10000);

    // Light
    Game.light = new THREE.PointLight(0xFFFFFF, Game.lightSize, Game.size * 10);
    Game.scene.add(Game.light);
    Game.lightTween1 = new Tween(Game.light).to({intensity: Game.lightSize + Game.lightVar}, 1200);
    Game.lightTween2 = new Tween(Game.light).to({intensity: Game.lightSize - Game.lightVar}, 1200);
    Game.lightTween1.chain(Game.lightTween2);
    Game.lightTween2.chain(Game.lightTween1);
    Game.lightTween1.start(); //@todo: easing, tween the position

    // Finish
    $container.append(Game.renderer.domElement);
};

/**
 * Render a map in 3d canvas
 */
Game.loadMap = function(map) {
    // Render map
    for (i = 0; i < map.floors.length; ++i) {
        var floor = map.floors[i];
        var mesh = new THREE.Mesh(
                new THREE.BoxGeometry(Game.size, Game.size / 20, Game.size),
                new THREE.MeshLambertMaterial({
                    map: new THREE.ImageUtils.loadTexture("img/textures/floor1.png") //@todo: preload
                }));
        mesh.position.x = floor.x * Game.size;
        mesh.position.z = floor.y * Game.size;
        mesh.position.y = -Game.size / 2;
        Game.scene.add(mesh);
    }

    for (i = 0; i < map.walls.length; ++i) {
        var wall = map.walls[i];
        var mesh = new THREE.Mesh(
                new THREE.BoxGeometry(Game.size, Game.size, Game.size),
                new THREE.MeshLambertMaterial({
                    map: new THREE.ImageUtils.loadTexture("img/textures/wall1.png") //@todo: preload
                }));
        mesh.position.x = wall.x * Game.size;
        mesh.position.z = wall.y * Game.size;
        mesh.position.y = 0;
        Game.scene.add(mesh);
    }

    //Render sprites
    for (i = 0; i < map.objects.length; ++i) {
        var obj = map.objects[i];

        Game.sprite = new THREE.Sprite(new THREE.SpriteMaterial({
                         map: new THREE.TextureLoader().load("img/sprites/sprite1.png"),
                         //color: 0xffffff,
                         fog: false }));

        Game.sprite.scale.multiplyScalar(40);
        Game.sprite.position.x = obj.x * Game.size;
        Game.sprite.position.z = obj.y * Game.size;
        Game.sprite.position.y = 0;
        Game.scene.add(Game.sprite);
    }

    // Set player position. The first object is the starting point.
    var start = map.objects[0];
    Game.camera.position.x = start.x * Game.size;
    Game.camera.position.z = start.y * Game.size;
    Game.camera.position.y = 0;
    Game.player.x = start.x;
    Game.player.y = start.y;
};

/**
 * 3d render update
 */
Game.render = function() {
    Game.light.position.copy(Game.camera.position);
    Game.renderer.render(Game.scene, Game.camera);
};

/**
 * Begins animation cycle
 */
Game.animate = function() {
    requestAnimationFrame(Game.animate);
    Game.render();
};

/**
 * Collision with an object or wall
 */
Game.checkCollision = function(x, y) {
    return (Game.map.colmap[x][y] == 1);
}

Game._drawArrow = function(origin, dir, length) {
    var length = length * Game.size;
    var hex = 0xffff00;
    var arrowHelper = new THREE.ArrowHelper(dir, origin, lenght, hex);
    Game.scene.add(arrowHelper);
}

/**
 * Player rotations and translations
 */
Game.forward = function() { Game._move(-1); };
Game.backward = function() { Game._move(1); };
Game._move = function(d) {
    if (!Game.isMoving) {
        var x = Game.camera.position.x;
        var z = Game.camera.position.z;
        var vert = Math.round(Math.cos(Game.camera.rotation.y));
        var horz = Math.round(Math.sin(Game.camera.rotation.y));
        var newx = x + d * horz * Game.size;
        var newz = z + d * vert * Game.size;

        var newPx = Game.player.x + d * horz;
        var newPy = Game.player.y + d * vert;

        if (Game.checkCollision(newPx, newPy)) {;
            return;
        } else {
            Game.isMoving = true;
            Game.player.x = newPx;
            Game.player.y = newPy;
            Game.map2dPoint.x = newPx * Game.map2dSize;
            Game.map2dPoint.y = newPy * Game.map2dSize;
            var tw = new Tween(Game.camera.position).to({ x: newx, z: newz }, Game.moveSpeed)
                                                    .onFinish(function() { Game.isMoving = false })
                                                    .start();
        }
    }
};

Game.rotateRight = function() { Game._rotate(-1); };
Game.rotateLeft = function() { Game._rotate(1); };
Game._rotate = function(d) {
    if (!Game.isMoving) {
        Game.isMoving = true;
        var y = Game.camera.rotation.y;
        var tw = new Tween(Game.camera.rotation).to({ y: y + d * (Math.PI / 2) }, Game.moveSpeed)
                                                .onFinish(function() { Game.isMoving = false})
                                                .start();
    }
}

Game.keyboardHandler = function(e) {
    switch (e.keyCode) {
        case 37: // left arrow key
            Game.rotateLeft();
            e.preventDefault();
            break;
        case 38: // up arrow key
            Game.forward();
            e.preventDefault();
            break;
        case 39: // right arrow key
            Game.rotateRight();
            e.preventDefault();
        case 40: // up arrow key
            Game.backward();
            e.preventDefault();
            break;
        default:
            console.log("unmapped_keycode", e.keyCode);
    }
};




/**
 * App entry point
 */
window.onload = function() {
    //3d init
    Game.init3d();
    Game.animate();

    // Load a map and render in 2d and 3d
    $.get("backend.php/map/1", function(data) {
        Game.map = data.map;
        $("h1").html(data.map.name);
        Game.render2dMap(data.map);
        Game.loadMap(data.map);
    });

    // Set keyboard handler
    $(window).keydown(Game.keyboardHandler);
}


</script>

    </body>
</html>